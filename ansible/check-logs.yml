---
- name: Check Logs to Diagnose Morning 504 Error
  hosts: flask
  become: true
  tasks:
    - name: Check Docker container logs (last 100 lines)
      shell: sudo docker logs flask-app --tail 100 2>&1 || echo "Container not found or no logs"
      register: docker_logs
      
    - name: Show Docker container logs
      debug:
        msg: "{{ docker_logs.stdout_lines }}"

    - name: Check for OOM (Out Of Memory) events in dmesg
      shell: sudo dmesg -T | grep -i "out of memory\|oom\|killed process" | tail -20 || echo "No OOM events found"
      register: oom_events
      
    - name: Show OOM events
      debug:
        msg: "{{ oom_events.stdout_lines }}"

    - name: Check system journal for OOM events
      shell: sudo journalctl -k --since "24 hours ago" | grep -i "out of memory\|oom\|killed" | tail -20 || echo "No OOM events in journal"
      register: journal_oom
      
    - name: Show journal OOM events
      debug:
        msg: "{{ journal_oom.stdout_lines }}"

    - name: Check system journal for Docker errors
      shell: sudo journalctl -u docker --since "24 hours ago" --no-pager | tail -50 || echo "No Docker journal entries"
      register: docker_journal
      
    - name: Show Docker journal entries
      debug:
        msg: "{{ docker_journal.stdout_lines }}"

    - name: Check system memory history (last 24 hours)
      shell: |
        echo "=== Current Memory ==="
        free -h
        echo ""
        echo "=== Memory usage by process ==="
        ps aux --sort=-%mem | head -10
      register: memory_info
      
    - name: Show memory information
      debug:
        msg: "{{ memory_info.stdout_lines }}"

    - name: Check disk space
      shell: df -h
      register: disk_space
      
    - name: Show disk space
      debug:
        msg: "{{ disk_space.stdout_lines }}"

    - name: Check container restart count
      shell: sudo docker inspect flask-app --format='{{"{{"}}.RestartCount{{"}}"}}' 2>/dev/null || echo "0"
      register: restart_count
      
    - name: Show container restart count
      debug:
        msg: "Container has been restarted {{ restart_count.stdout }} times"

    - name: Check container exit codes
      shell: sudo docker inspect flask-app --format='{{"{{"}}json .State{{"}}"}}' 2>/dev/null | python3 -m json.tool || echo "Cannot get container state"
      register: container_state
      
    - name: Show container state
      debug:
        msg: "{{ container_state.stdout_lines }}"

    - name: Check for gunicorn worker timeout errors
      shell: sudo docker logs flask-app 2>&1 | grep -i "worker timeout\|timeout\|out of memory" | tail -20 || echo "No timeout errors found"
      register: timeout_errors
      
    - name: Show timeout errors
      debug:
        msg: "{{ timeout_errors.stdout_lines }}"

    - name: Check system uptime and load
      shell: |
        echo "=== System Uptime ==="
        uptime
        echo ""
        echo "=== Load Average ==="
        cat /proc/loadavg
      register: system_info
      
    - name: Show system information
      debug:
        msg: "{{ system_info.stdout_lines }}"

