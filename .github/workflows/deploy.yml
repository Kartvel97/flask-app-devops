name: Deploy Full Stack to AWS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'docker/**'
      - 'monitoring/**'
      - '.github/workflows/deploy.yml'
      - 'backup/**'
      - 'tests/**'
      - 'pytest.ini'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: kartvel97/flask-app-devops

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r docker/requirements.txt

      - name: Install test dependencies
        run: |
          pip install -r tests/requirements.txt

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing || echo "Some tests failed, but continuing..."

      - name: Run basic checks
        run: |
          python -c "import flask; print('Flask installed successfully')"
          python -c "from src.app import app; print('App imported successfully')"
          echo "All basic checks passed"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker Buildx for building images (learned from GitHub Actions documentation)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry (learned from GitHub Actions documentation)
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Full Stack to AWS
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_KEY }}
          timeout: 300s
          command_timeout: 600s
          script: |
            echo "Starting full stack deployment..."

            sudo git config --global --add safe.directory /opt/flask-app
            cd /opt/flask-app
            sudo git stash || true
            sudo git pull origin main

            echo "Creating Docker network..."
            sudo docker network create monitoring 2>/dev/null || true

            echo "Deploying Flask application..."
            
            sudo docker stop flask-app || true
            sudo docker rm flask-app || true

            echo "Pulling Docker image from registry..."
            echo "${{ secrets.GHCR_PAT }}" | sudo docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            sudo docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main || echo "Image pull failed, will build locally"
            
            if sudo docker images | grep -q "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"; then
              echo "Using pre-built image from registry"
              sudo docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main flask-app:latest
            else
              echo "Building Docker image locally..."
              sudo docker build -t flask-app -f docker/Dockerfile .
            fi

            if [ ! -f "docker-compose.app.yml" ]; then
              echo "Copying docker-compose.app.yml..."
              sudo cp docker/docker-compose.app.yml docker-compose.app.yml
            fi

            echo "Starting Flask app with docker-compose..."
            sudo docker-compose -f docker-compose.app.yml up -d

            echo "Waiting for Flask app container to be ready..."
            COUNTER=0
            MAX_ATTEMPTS=30
            while [ $COUNTER -lt $MAX_ATTEMPTS ]; do
              if sudo docker ps | grep -q flask-app; then
                echo "Flask app container is running"
                break
              fi
              if [ $COUNTER -eq $((MAX_ATTEMPTS - 1)) ]; then
                echo "Flask app container failed to start"
                echo "Checking container status:"
                sudo docker ps -a | grep flask-app || echo "Container not found"
                exit 1
              fi
              echo "Attempt $((COUNTER + 1))/$MAX_ATTEMPTS: Waiting for Flask app container..."
              sleep 2
              COUNTER=$((COUNTER + 1))
            done

            echo "Waiting for Flask app to be healthy..."
            COUNTER=0
            MAX_ATTEMPTS=30
            while [ $COUNTER -lt $MAX_ATTEMPTS ]; do
              if curl -s http://localhost:5000/health > /dev/null 2>&1; then
                echo "Flask app is healthy"
                break
              fi
              if [ $COUNTER -eq $((MAX_ATTEMPTS - 1)) ]; then
                echo "Flask app health check failed after $MAX_ATTEMPTS attempts (continuing anyway)"
                echo "Checking container logs:"
                sudo docker logs flask-app --tail 50 || echo "Could not get container logs"
              fi
              echo "Attempt $((COUNTER + 1))/$MAX_ATTEMPTS: Waiting for Flask app health..."
              sleep 5
              COUNTER=$((COUNTER + 1))
            done

            echo "Setting up monitoring stack..."
            
            sudo mkdir -p /opt/monitoring/grafana/provisioning/datasources
            sudo mkdir -p /opt/monitoring/grafana/dashboards
            sudo mkdir -p /opt/monitoring/prometheus
            sudo mkdir -p /opt/monitoring/loki
            sudo mkdir -p /opt/monitoring/promtail

            echo "Copying monitoring configuration..."
            if [ -d "/opt/flask-app/monitoring" ]; then
              sudo cp -r /opt/flask-app/monitoring/* /opt/monitoring/
              if [ -f "/opt/monitoring/grafana/import-dashboards.sh" ]; then
                sudo chmod +x /opt/monitoring/grafana/import-dashboards.sh
              fi
              if [ -f "/opt/monitoring/grafana/setup-alerts.sh" ]; then
                sudo chmod +x /opt/monitoring/grafana/setup-alerts.sh
              fi
            else
              echo "Monitoring directory not found in repository"
              exit 1
            fi

            echo "Verifying Loki and Promtail configurations..."
            if [ ! -f "/opt/monitoring/loki/loki-config.yml" ]; then
              echo "Loki config not found, creating default..."
              sudo mkdir -p /opt/monitoring/loki
            fi
            if [ ! -f "/opt/monitoring/promtail/promtail-config.yml" ]; then
              echo "Promtail config not found, creating default..."
              sudo mkdir -p /opt/monitoring/promtail
            fi

            echo "Configuring Prometheus for Docker network..."
            sudo sed -i 's/host.docker.internal:5000/flask-app:5000/g' /opt/monitoring/prometheus/prometheus.yml
            sudo sed -i 's/172.17.0.1:5000/flask-app:5000/g' /opt/monitoring/prometheus/prometheus.yml

            echo "Connecting Flask app to monitoring network..."
            sudo docker network connect monitoring flask-app 2>/dev/null || echo "Container already connected or network doesn't exist yet"

            echo "Testing DNS resolution in Docker network..."
            sudo docker run --rm --network monitoring alpine nslookup flask-app 2>/dev/null || echo "DNS test failed, will use service name"

            echo "Getting Flask app IP address..."
            FLASK_IP=$(sudo docker inspect flask-app 2>/dev/null | grep -A 20 "Networks" | grep '"IPAddress"' | grep -v '""' | head -1 | cut -d'"' -f4 || echo "")
            if [ ! -z "$FLASK_IP" ] && [ "$FLASK_IP" != "null" ]; then
                echo "Found Flask app IP: $FLASK_IP (will use service name 'flask-app' instead)"
            else
                echo "Using service name 'flask-app' for Prometheus scraping"
            fi

            echo "Fixing permissions..."
            sudo chown -R $USER:$USER /opt/monitoring 2>/dev/null || sudo chown -R $(whoami):$(whoami) /opt/monitoring 2>/dev/null || true
            sudo chmod -R 755 /opt/monitoring 2>/dev/null || true

            echo "Setting up automated backup system..."
            if [ -d "/opt/flask-app/backup" ]; then
              echo "Installing AWS CLI..."
              if ! command -v aws >/dev/null 2>&1; then
                sudo apt-get update -qq
                sudo apt-get install -y awscli >/dev/null 2>&1 || {
                  echo "Failed to install AWS CLI via apt, trying alternative method..."
                  curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip 2>/dev/null || true
                  if [ -f /tmp/awscliv2.zip ]; then
                    sudo apt-get install -y unzip >/dev/null 2>&1
                    unzip -q /tmp/awscliv2.zip -d /tmp
                    sudo /tmp/aws/install >/dev/null 2>&1 || echo "AWS CLI installation failed, S3 backup will be disabled"
                  fi
                }
              fi
              
              echo "Detecting S3 bucket for backups..."
              if command -v aws >/dev/null 2>&1; then
                S3_BUCKET=$(aws ec2 describe-tags \
                  --filters "Name=resource-type,Values=instance" \
                           "Name=key,Values=S3BackupBucket" \
                  --query 'Tags[0].Value' \
                  --output text 2>/dev/null || echo "")
                
                if [ -z "$S3_BUCKET" ]; then
                  S3_BUCKET=$(aws s3 ls 2>/dev/null | grep "flask-app-backups" | awk '{print $3}' | head -1 || echo "")
                fi
                
                if [ -n "$S3_BUCKET" ]; then
                  echo "Found S3 bucket: $S3_BUCKET"
                  echo "export S3_BUCKET=$S3_BUCKET" | sudo tee -a /etc/environment > /dev/null
                else
                  echo "S3 bucket not found. Backups will be stored locally only."
                  echo "To enable S3: Run 'terraform output s3_backup_bucket' and set S3_BUCKET environment variable"
                fi
              fi
              
              sudo mkdir -p /opt/backups
              sudo chmod 755 /opt/backups
              
              sudo cp /opt/flask-app/backup/scripts/*.sh /usr/local/bin/
              sudo chmod +x /usr/local/bin/backup.sh
              sudo chmod +x /usr/local/bin/restore.sh
              sudo chmod +x /usr/local/bin/verify_backup.sh
              
              sudo bash -c 'printf "[Unit]\nDescription=Automated Backup Service for Flask App Stack\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/backup.sh\nStandardOutput=journal\nStandardError=journal\n\n[Install]\nWantedBy=multi-user.target\n" > /etc/systemd/system/flask-backup.service'
              
              sudo bash -c 'printf "[Unit]\nDescription=Run Flask App Backup Daily\nRequires=flask-backup.service\n\n[Timer]\nOnCalendar=daily\nOnCalendar=*-*-* 02:00:00\nPersistent=true\nRandomizedDelaySec=3600\n\n[Install]\nWantedBy=timers.target\n" > /etc/systemd/system/flask-backup.timer'
              
              sudo systemctl daemon-reload
              sudo systemctl enable flask-backup.timer
              sudo systemctl start flask-backup.timer
              
              echo "Backup system configured (daily at 02:00 UTC)"
            else
              echo "Backup directory not found, skipping backup setup"
            fi

            echo "Setting up Grafana credentials..."
            if [ ! -f "/opt/monitoring/.env" ]; then
              echo "Grafana .env file not found, creating from example..."
              if [ -f "/opt/flask-app/monitoring/.env.example" ]; then
                sudo cp /opt/flask-app/monitoring/.env.example /opt/monitoring/.env
                GRAFANA_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
                sudo sed -i "s/your_secure_password_here/${GRAFANA_PASSWORD}/" /opt/monitoring/.env
                echo "Grafana password generated and saved to .env"
                
                echo "${GRAFANA_PASSWORD}" | sudo tee /opt/monitoring/grafana-password.txt > /dev/null
                sudo chmod 600 /opt/monitoring/grafana-password.txt
                echo "Grafana password saved to: /opt/monitoring/grafana-password.txt"
                echo ""
                echo "Grafana credentials:"
                echo "   Username: admin"
                echo "   Password: ${GRAFANA_PASSWORD}"
                echo ""
                echo "To get password later, run:"
                echo "   cat /opt/monitoring/grafana-password.txt"
                echo "   or"
                echo "   grep GRAFANA_ADMIN_PASSWORD /opt/monitoring/.env | cut -d'=' -f2"
              else
                echo ".env.example not found, using default password (CHANGE IT!)"
                DEFAULT_PASS="ChangeMe123!"
                sudo bash -c "printf 'GRAFANA_ADMIN_USER=admin\nGRAFANA_ADMIN_PASSWORD=%s\n' ${DEFAULT_PASS} > /opt/monitoring/.env"
                echo "${DEFAULT_PASS}" | sudo tee /opt/monitoring/grafana-password.txt > /dev/null
                sudo chmod 600 /opt/monitoring/grafana-password.txt
              fi
            else
              echo "Grafana .env file already exists"
              if [ -f "/opt/monitoring/.env" ]; then
                EXISTING_PASS=$(grep GRAFANA_ADMIN_PASSWORD /opt/monitoring/.env | cut -d'=' -f2)
                if [ ! -z "$EXISTING_PASS" ]; then
                  echo "$EXISTING_PASS" | sudo tee /opt/monitoring/grafana-password.txt > /dev/null
                  sudo chmod 600 /opt/monitoring/grafana-password.txt
                  echo "Password extracted and saved to: /opt/monitoring/grafana-password.txt"
                fi
              fi
            fi

            echo "Starting monitoring services..."
            cd /opt/monitoring
            sudo docker-compose -f docker-compose.monitoring.yml down || true
            
            echo "Ensuring Flask app is on monitoring network..."
            sudo docker network connect monitoring flask-app 2>/dev/null || echo "Already connected or will connect later"
            
            sudo docker-compose -f docker-compose.monitoring.yml up -d

            echo "Waiting for monitoring services to start..."
            sleep 30
            
            echo "Checking monitoring services status..."
            sudo docker-compose -f docker-compose.monitoring.yml ps

            echo "Verifying Loki and Promtail..."
            if sudo docker ps | grep -q loki; then
              echo "Loki container is running"
              if curl -s http://localhost:3100/ready > /dev/null 2>&1; then
                echo "Loki is healthy and ready"
              else
                echo "Loki container is running but health check failed"
                echo "Loki logs:"
                sudo docker logs loki --tail 20 || echo "Could not get Loki logs"
              fi
            else
              echo "Loki is not running"
              echo "Checking Loki container status:"
              sudo docker ps -a | grep loki || echo "Loki container not found"
            fi
            
            if sudo docker ps | grep -q promtail; then
              echo "Promtail container is running"
              if curl -s http://localhost:9080/ready > /dev/null 2>&1; then
                echo "Promtail is healthy and ready"
              else
                echo "Promtail container is running but health check failed"
                echo "Promtail logs:"
                sudo docker logs promtail --tail 20 || echo "Could not get Promtail logs"
              fi
            else
              echo "Promtail is not running"
              echo "Checking Promtail container status:"
              sudo docker ps -a | grep promtail || echo "Promtail container not found"
            fi
            
            echo "Checking if Loki is receiving logs..."
            sleep 5
            LOKI_LABELS=$(curl -s http://localhost:3100/loki/api/v1/labels 2>/dev/null || echo "{}")
            if echo "$LOKI_LABELS" | grep -q "container"; then
              echo "Loki is receiving logs (found labels)"
            else
              echo "Loki is not receiving logs yet (this is normal if containers just started)"
              echo "Loki labels response: $LOKI_LABELS"
            fi

            echo "Verifying deployment..."
            
            echo "=== Running Containers ==="
            sudo docker ps

            echo "=== Network Info ==="
            sudo docker network inspect monitoring 2>/dev/null | grep -A 10 "Containers" || echo "Network inspection failed"

            echo "=== Service Health Checks ==="

            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "Flask app is healthy"
            else
              echo "Flask app health check failed (but may be OK)"
            fi

            if curl -s http://localhost:9090/-/healthy > /dev/null 2>&1; then
              echo "Prometheus is healthy"
            else
              echo "Prometheus health check failed (but may be OK)"
            fi

            if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Grafana is healthy"
            else
              echo "Grafana health check failed (but may be OK)"
            fi

            echo "=== Prometheus Targets ==="
            PROM_TARGETS=$(curl -s http://localhost:9090/api/v1/targets 2>/dev/null || echo "{}")
            if command -v jq > /dev/null 2>&1; then
              echo "$PROM_TARGETS" | jq -r '.data.activeTargets[] | "\(.labels.job): \(.health)"' 2>/dev/null || echo "Could not parse targets"
            else
              echo "Install jq for better target output"
              echo "$PROM_TARGETS" | grep -o '"job":"[^"]*"[^}]*"health":"[^"]*"' | head -10
            fi

            echo "Importing Grafana Labs dashboards..."
            sleep 10
            if [ -f "/opt/monitoring/grafana/import-dashboards.sh" ] && [ -f "/opt/monitoring/grafana-password.txt" ]; then
              GRAFANA_PASSWORD=$(sudo cat /opt/monitoring/grafana-password.txt)
              cd /opt/monitoring
              GRAFANA_URL="http://localhost:3000" GRAFANA_USER="admin" GRAFANA_PASSWORD="${GRAFANA_PASSWORD}" \
                bash /opt/monitoring/grafana/import-dashboards.sh || echo "Dashboard import failed (may need manual import)"
            else
              echo "Dashboard import script or password file not found, skipping"
            fi
            
            echo "Setting up Grafana alert rules..."
            sleep 5
            if [ -f "/opt/monitoring/grafana/setup-alerts.sh" ] && [ -f "/opt/monitoring/grafana-password.txt" ]; then
              GRAFANA_PASSWORD=$(sudo cat /opt/monitoring/grafana-password.txt)
              cd /opt/monitoring
              GRAFANA_URL="http://localhost:3000" GRAFANA_USER="admin" GRAFANA_PASSWORD="${GRAFANA_PASSWORD}" \
                bash /opt/monitoring/grafana/setup-alerts.sh || echo "Alert setup failed (may need manual setup)"
            else
              echo "Alert setup script or password file not found, skipping"
            fi

            echo "Full stack deployment completed!"
            echo ""
            echo "Access URLs:"
            echo "   - Flask App:      http://${{ secrets.AWS_HOST }}:5000"
            echo "   - Grafana:        http://${{ secrets.AWS_HOST }}:3000"
            echo "     Get password:   cat /opt/monitoring/grafana-password.txt"
            echo "   - Prometheus:     http://${{ secrets.AWS_HOST }}:9090"
            echo "   - Loki:           http://${{ secrets.AWS_HOST }}:3100"
            echo "   - Node Exporter:  http://${{ secrets.AWS_HOST }}:9100"
            echo "   - cAdvisor:       http://${{ secrets.AWS_HOST }}:8080"
            echo ""
            echo "Security Features:"
            echo "   - SSH access configured"
            echo "   - Rate limiting enabled in Nginx"
            echo "   - Structured logging with Loki"
            echo "   - Error handling and monitoring"
            echo ""
            echo "Backup & Recovery:"
            echo "   - Automated daily backups at 02:00 UTC"
            echo "   - Backup retention: 7 days (local), 30 days (S3)"
            echo "   - Local backup: /opt/backups"
            if command -v aws >/dev/null 2>&1 && [ -n "$S3_BUCKET" ]; then
              echo "   - S3 backup: s3://$S3_BUCKET/backups/"
            else
              echo "   - S3 backup: Not configured (install AWS CLI and set S3_BUCKET)"
            fi
            echo "   - Manual backup: /usr/local/bin/backup.sh"
            echo "   - Restore: /usr/local/bin/restore.sh <backup_file>"
            echo ""
            echo "Quick Debug Commands:"
            echo "   sudo docker ps -a"
            echo "   sudo docker logs flask-app"
            echo "   curl http://localhost:5000/health"
            echo ""
            echo "Get Grafana Password:"
            echo "   cat /opt/monitoring/grafana-password.txt"
            echo "   curl http://localhost:9090/targets | grep flask-app"